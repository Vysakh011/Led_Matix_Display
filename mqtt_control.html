<!DOCTYPE html>
<html>
<head>
    <title>MQTT Control Panel</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        #brokerInfo {
            margin: 10px 0;
            padding: 10px;
            background: #e2e3e5;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>MQTT Control Panel</h1>
    <div id="status" class="disconnected">Disconnected</div>
    <div id="brokerInfo">Current Broker: <span id="currentBroker">None</span></div>
    
    <div>
        <input type="text" id="message" placeholder="Enter message">
        <button id="send">Send</button>
        <button id="clear">Clear Display</button>
    </div>
    
    <div id="messages"></div>

    <script>
        // MQTT Configuration
        const brokers = [
            { name: "HiveMQ", url: "wss://broker.hivemq.com:8884/mqtt", index: 0 },
            { name: "Mosquitto", url: "wss://test.mosquitto.org:8081/mqtt", index: 1 },
            { name: "Eclipse", url: "wss://mqtt.eclipseprojects.io:443/mqtt", index: 2 }
        ];
        let currentBrokerIndex = 0;
        let client = null;

        // Topics
        const commandTopic = "ece/diFJBNOUIFOVSKJIGWIGJ";
        const sensorTopic = "ece/sensorDataujndubd";
        const brokerSyncTopic = "ece/brokerSync";

        function connectToBroker() {
            const status = document.getElementById('status');
            const brokerInfo = document.getElementById('currentBroker');
            
            status.className = 'disconnected';
            status.textContent = 'Connecting...';
            
            if (client) {
                client.end();
            }

            client = mqtt.connect(brokers[currentBrokerIndex].url, {
                clientId: 'web-client-' + Math.random().toString(16).substr(2, 8),
                clean: true
            });

            client.on('connect', () => {
                status.className = 'connected';
                status.textContent = 'Connected';
                brokerInfo.textContent = brokers[currentBrokerIndex].name;
                
                client.subscribe(sensorTopic);
                client.subscribe(brokerSyncTopic);
                
                // Announce our current broker
                const syncMsg = JSON.stringify({
                    brokerIndex: currentBrokerIndex,
                    brokerName: brokers[currentBrokerIndex].name
                });
                client.publish(brokerSyncTopic, syncMsg);
            });

            client.on('message', (topic, message) => {
                if (topic === brokerSyncTopic) {
                    try {
                        const data = JSON.parse(message.toString());
                        if (data.brokerIndex !== undefined && 
                            data.brokerIndex !== currentBrokerIndex &&
                            data.brokerIndex >= 0 && 
                            data.brokerIndex < brokers.length) {
                            
                            currentBrokerIndex = data.brokerIndex;
                            connectToBroker(); // Reconnect to new broker
                        }
                    } catch (e) {
                        console.error('Error parsing sync message:', e);
                    }
                    return;
                }
                
                // Handle other messages...
                console.log(`Message on ${topic}: ${message.toString()}`);
                const msgDiv = document.createElement('div');
                msgDiv.textContent = `[${topic}] ${message.toString()}`;
                document.getElementById('messages').appendChild(msgDiv);
            });

            client.on('error', (err) => {
                console.error('Connection error:', err);
                status.className = 'disconnected';
                status.textContent = 'Error: ' + err.message;
            });

            client.on('close', () => {
                status.className = 'disconnected';
                status.textContent = 'Disconnected';
            });
        }

        document.getElementById('send').addEventListener('click', () => {
            const message = document.getElementById('message').value;
            if (client && client.connected && message) {
                client.publish(commandTopic, message);
            }
        });

        document.getElementById('clear').addEventListener('click', () => {
            if (client && client.connected) {
                client.publish(commandTopic, "CLE@R");
            }
        });

        // Initial connection
        connectToBroker();
    </script>
</body>
</html>
